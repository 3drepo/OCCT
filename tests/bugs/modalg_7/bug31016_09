puts "========"
puts "OCC31016"
puts "========"
puts ""
###################################################################
# Projection of an ellipse or a circle is a B-spline in some cases
###################################################################

circle c 0 0 0  10
plane p 0 0 0  1 0 1
projonplane r c p 1

if {![regexp {BSplineCurve} [dump r]]} {
  puts "ERROR: Projected curve is not a B-spline curve"
}

proc toPlane {pln curve param} {
  upvar $pln p
  upvar $curve crv
  cvalue crv $param x y z
  set pr [proj p x y z]
  regexp {Parameters: ([-0-9.+eE]+) ([-0-9.+eE]+)} $pr full u v
  svalue p $u $v x y z

  set pntOnPlane {}
  lappend pntOnPlane [dval x]
  lappend pntOnPlane [dval y]
  lappend pntOnPlane [dval z]
  return $pntOnPlane
}

# calculate a parametric shift on the projected curve
set pnt [toPlane p c 0]

set nbPoints 100
for {set i 0} {$i <= $nbPoints} {incr i} {
  set par0 [expr 8*atan(1)*$i/$nbPoints]

  set pnt [toPlane p c $par0]
  cvalue r $par0 X Y Z

  set dx [expr [lindex $pnt 0]-[dval X]]
  set dy [expr [lindex $pnt 1]-[dval Y]]
  set dz [expr [lindex $pnt 2]-[dval Z]]

  if {[expr $dx*$dx + $dy*$dy + $dz*$dz] < 1.e-12} {
    puts "OK: Projection correct"
  } else {
    puts "ERROR: Projection incorrect"
  }
}
